<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>rickvandeloo.com</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Homepage of Rick van de Loo">

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body {
        padding-top: 60px;
      }
    </style>
    <link href="/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="/css/zenburn.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></sc\
ript>
    <![endif]-->
  </head>

  <body>

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">rickvandeloo.com</a>
            <ul class="nav">
              <li class="active"><a href="/">Home</a></li>
              <li class="btn-navbar active" style="padding: 0;"><a href="#about">About</a></li>
            </ul>
        </div>
      </div>
    </div>

    <div class="container">

<div class="row-fluid">
  <div class="span8">
    

<div class="row-fluid">
  <div class="span12">
    <h2><a href="/2014/11/24/configuring-network-bridge-debian-jessie-static-address/">Configuring a network bridge on Debian 8.0 for static addresses</a></h2>
    <h4>24 November 2014</h4>
	<p>Setting up bridge-utils to work correctly is something I only have to do
once every so often. It is one of those things where you end up chasing
the same rabbit hole of documentation over and over again in order to get
it to work whilst banging your against the wall. The reason why bridged
networking can end up being so frustrating isn’t because it is difficult
(it’s actually pretty straight forward) but because if you mess up, it
could mean a nice trip down to where you parked the hardware. I mostly use
network bridging on physical machines in order <a href="http://wiki.qemu.org/Documentation/Networking">to connect qemu machines
to the internet</a> using
<a href="http://en.wikipedia.org/wiki/TUN/TAP">TUN/TAP</a>.</p>

<p>Messing up a bridge-utils configuration has resulted in me borking
networking on remote and headless machines more than once now. To prevent
myself (and maybe you) some future headaches and lock-outs, this is how to
configure a bridge by the name of br0 with static IPs for interfaces eth0
and tap0 on a fresh install of Debian 8.0 jessie/sid.</p>

<p>Firstly make sure bridge-utils is on the system</p>

<div class="highlight"><pre><code class="bash"><span class="c"># apt-get install bridge-utils</span>
</code></pre>
</div>


<p>Then put something like this based on your network preferences in
/etc/network/interfaces.
I recommend commenting out the original configuration lines instead of
deleting them.</p>

<div class="highlight"><pre><code class="bash">iface lo inet loopback

allow-hotplug eth0
iface eth0 inet static
        address 192.168.1.155   <span class="c">#eth0 ip</span>
        netmask 255.255.255.0
        gateway 192.168.1.1

allow-hotplug tap0
iface tap0 inet static
        address 192.168.1.4 <span class="c">#tap0 ip</span>
        netmask 255.255.255.0
        gateway 192.168.1.1

auto br0
iface br0 inet static
        address 192.168.1.2 <span class="c">#bridge ip</span>
        netmask 255.255.255.0
        broadcast 192.168.1.255
        gateway 192.168.1.1
        bridge_ports eth0 tap0
        bridge_fd 9
        bridge_hello 2
        bridge_maxage 12
        bridge_stp off
</code></pre>
</div>


<p>The next step is unbinding all ipv4 addresses from the eth0 interface and
restarting networking through systemd.</p>

<p>WARNING: this is the point of no return, there is a good chance you are
going to lock yourself out of the box. If you have no way of getting
a shell other than through the network, think twice before proceeding.
I take no responsibility of you break something. More information
<a href="http://www.tldp.org/HOWTO/Ethernet-Bridge-netfilter-HOWTO-3.html">here</a>.</p>

<div class="highlight"><pre><code class="bash"><span class="c"># ifconfig eth0 0.0.0.0 down; systemctl restart networking</span>
</code></pre>
</div>


<p>Or the non systemd way:</p>

<div class="highlight"><pre><code class="bash"><span class="c"># ifconfig eth0 0.0.0.0 down; service networking restart</span>
</code></pre>
</div>




	
  </div>
    <p>
      <a href="/2014/11/24/configuring-network-bridge-debian-jessie-static-address/">Permalink</a>
    </p>
</div>
<hr>



<div class="row-fluid">
  <div class="span12">
    <h2><a href="/2014/11/21/partially-synchronising-a-structured-folder-to-smaller-storage/">Partially synchronising a structured folder (on a Synology machine) to a smaller storage</a></h2>
    <h4>21 November 2014</h4>
	<p>One of the most enjoyable things writing code has to offer is automating
tasks to the point where you can completely forget about them. There is
nothing like walking down the street and getting an email on your phone
from some long forgotten process, reminding you that something happened
and thinking “I can’t remember how that works but I built that”. Recently
I’ve been dusting off and cleaning up some of my personal scripts to
publish up on <a href="https://github.com/vdloo">my GitHub account</a> and in the
process I stumbled upon a problem I solved a long time ago which on
initial glance seemed really simple but ended up being rather treacherous.</p>

<p>The situation is as follows: imagine a Synology server storing a video
library where files are stored with a certain directory structure. This
structure is important because Kodi (previously XBMC) requires <a href="http://kodi.wiki/view/Naming_video_files/TV_shows">specific
naming conventions</a> in
order to succesfully index TV shows in its library.</p>

<p>Now imagine that you move out to go to college and scramble together
a small machine to use as a HTPC. The cpu is fine, the gpu is fine, but
the storage capacity is not nearly as much as you’ve grown accustomed to.
You can’t mount the server at home as remote storage because your Austrian
roommate will forever nag you about the traffic messing up his Dota game
and the connection isn’t fast enough to stream anyway. So what do you do?</p>

<p>I figured that the most logical solution was to just rsync all the files
in the directory to the local machine until the volume was full, starting
with file that was modified last. Seems easy right? How about something
with</p>

<div class="highlight"><pre><code class="bash">find . -type f -printf <span class="s1">&#39;%T@ %p\n&#39;</span>
</code></pre>
</div>


<p>Just pipe that into sort and xargs to rsync the files individually to the
HTPC until the volume is full. Unfortunately its not that simple. Synology
machines are equipped with Busybox binaries instead of proper GNU
utilities. This means that there is no -printf flag on the find or the
xargs command, the stat command is severely limited and the default shell
is <a href="http://en.wikipedia.org/wiki/Almquist_shell">Almquist shell</a>. This
limits the options and convenience quite a bit. Some fancy glob shelling
trick won’t be possible too. A savage option would be to pipe something
from ls, but even that was off the table due to the not functioning ‘-e
List full date and time’  flag of the BusyBox implementation. A compromise
could be made where the ‘-mtime’ find flag could be used to simply get all
the files not older than a certain amount of time but I didn’t like the
idea of having the hdd just sitting there idely until new files came by.</p>

<p>The next step could be to look into options like utilizing the <a href="http://www.mdevries.org/synology_debian_chroot.html">Debian
chroot</a> or to find
some other way to get better binaries on the system. None of that seems
like the ‘clean’ way to do it but luckily there is another route to go.</p>

<p>My solution consists of two scripts. <a href="https://github.com/vdloo/dotfiles/blob/master/code/scripts/system/latestfilter.py">One Python script that runs on the
Synology
server</a>
to list all the files in the source directory and to create symlinks to
the latest files in a temporary directory until a certain amount of bytes
of data is reached. <a href="https://github.com/vdloo/dotfiles/blob/master/code/scripts/system/latestsync.sh">The second
script</a>
is a small shell script that runs on the remote machine.</p>

<p>This way every time the latestsync.sh script is run on the small server,
a directory is made on the large server, the dir is filled up with
symlinks to files sorted by age in a copy of the original directory
structure from the specified path until this new temporary directory has
reached the allocated amount of bytes specified in the script. Then rsync
on the smaller server will start pulling everything from that directory
down to the local volume.</p>

<p>To set it up drop the latestfilter.py script somewhere on the remote
server like for example</p>

<div class="highlight"><pre><code class="bash">wget https://raw.githubusercontent.com/vdloo/dotfiles/master/code/scripts/system/latestfilter.py -P /volume1/RAID5/other/code/scripts/system
</code></pre>
</div>


<p>On the local server download the latestsync.sh script to some directory</p>

<div class="highlight"><pre><code class="bash">wget https://raw.githubusercontent.com/vdloo/dotfiles/master/code/scripts/system/latestsync.sh -P ~/.dotfiles-public/code/scripts/system/
</code></pre>
</div>


<p>And run the script once in a while using a cron job like this based on
your configuration</p>

<div class="highlight"><pre><code class="bash">*       7,12,17,22      *       *       *       <span class="nv">SHELL</span><span class="o">=</span>/bin/bash <span class="nv">PATH</span><span class="o">=</span>/bin:/sbin:/usr/bin:/usr/sbin bash /home/vdloo/.dotfiles-public/code/scripts/system/latestsync.sh -h example.com -u vdloo -p 22 -a 1500000000000 -l /mnt/lvmdisk/series &gt; /dev/null 2&gt;&amp;1
</code></pre>
</div>




	
  </div>
    <p>
      <a href="/2014/11/21/partially-synchronising-a-structured-folder-to-smaller-storage/">Permalink</a>
    </p>
</div>
<hr>



<div class="row-fluid">
  <div class="span12">
    <h2><a href="/2014/07/03/fibonacci-in-finite-fields-in-racket/">Implementing Fibonacci in finite fields, in racket</a></h2>
    <h4>03 July 2014</h4>
	<p>A couple of days ago <a href="https://github.com/ruud-v-a">Ruud van Asseldonk</a>
submitted a post about <a href="http://ruudvanasseldonk.com/2014/07/01/fibonacci-numbers-in-finite-fields">Fibonacci numbers in finite
fields</a>.
In the post it is first explained that <a href="http://mathworld.wolfram.com/BinetsFibonacciNumberFormula.html">Binet's
formula</a>
holds up in a finite field, then an implementation of this method in c++
is presented. Since <a href="http://rickvandeloo.com/2014/07/02/why-I-am-starting-the-SICP-reading-project-this-summer/">I have started going through
SICP</a>,
I thought it would be a nice exercise to port this implementation to
scheme.</p>

<p>The author's implementation consists of five functions:</p>

<ol>
<li>addmod</li>
<li>submod</li>
<li>mulmod</li>
<li>powmod</li>
<li>fib</li>
</ol>


<p>Porting the first two function is pretty straight forward.</p>

<p>The original addmod function</p>

<div class="highlight"><pre><code class="cpp"><span class="n">u64</span> <span class="nf">addmod</span><span class="p">(</span><span class="n">u64</span> <span class="n">a</span><span class="p">,</span> <span class="n">u64</span> <span class="n">b</span><span class="p">,</span> <span class="n">u64</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="n">a</span><span class="p">)</span> <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">-</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>


<p>becomes:</p>

<div class="highlight"><pre><code class="racket"><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">addmod</span> <span class="nv">a</span> <span class="nv">b</span> <span class="nv">p</span><span class="p">)</span>
    <span class="p">(</span><span class="k">if </span> <span class="p">(</span><span class="nb">&gt; </span><span class="p">(</span><span class="nb">- </span><span class="nv">p</span> <span class="nv">b</span><span class="p">)</span> <span class="nv">a</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">+ </span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">- </span><span class="p">(</span><span class="nb">+ </span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span> <span class="nv">p</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre>
</div>


<p>and the original submod function</p>

<div class="highlight"><pre><code class="cpp"><span class="n">u64</span> <span class="nf">submod</span><span class="p">(</span><span class="n">u64</span> <span class="n">a</span><span class="p">,</span> <span class="n">u64</span> <span class="n">b</span><span class="p">,</span> <span class="n">u64</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;=</span> <span class="n">b</span><span class="p">)</span> <span class="k">return</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">return</span> <span class="n">p</span> <span class="o">-</span> <span class="n">b</span> <span class="o">+</span> <span class="n">a</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>


<p>becomes:</p>

<div class="highlight"><pre><code class="racket"><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">submod</span> <span class="nv">a</span> <span class="nv">b</span> <span class="nv">p</span><span class="p">)</span>
    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt;= </span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">- </span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nb">- </span><span class="nv">p</span> <span class="nv">b</span><span class="p">)</span> <span class="nv">a</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre>
</div>


<p>The mulmod function is a bit more complicated:</p>

<div class="highlight"><pre><code class="cpp"><span class="n">u64</span> <span class="nf">mulmod</span><span class="p">(</span><span class="n">u64</span> <span class="n">a</span><span class="p">,</span> <span class="n">u64</span> <span class="n">b</span><span class="p">,</span> <span class="n">u64</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u64</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">r</span> <span class="o">=</span> <span class="n">addmod</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
        <span class="n">b</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">addmod</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>


<p>The implementation in scheme displays more clearly the difference
between a functional programming language and the imperative c++. The
implementation in scheme is ostensibly inside out compared to the
original.</p>

<div class="highlight"><pre><code class="racket"><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">mulmod</span> <span class="nv">a</span> <span class="nv">b</span> <span class="nv">p</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">mulmod_rec</span> <span class="nv">a</span> <span class="nv">b</span> <span class="nv">p</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">)</span>
<span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">mulmod_rec</span> <span class="nv">a</span> <span class="nv">b</span> <span class="nv">p</span> <span class="nv">r</span><span class="p">)</span>
    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt; </span><span class="nv">b</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">mulmod_rec</span> <span class="p">(</span><span class="nf">addmod</span> <span class="nv">a</span> <span class="nv">a</span> <span class="nv">p</span><span class="p">)</span>
          <span class="p">(</span><span class="nb">arithmetic-shift </span><span class="nv">b</span> <span class="mi">-1</span><span class="p">)</span>
          <span class="nv">p</span>
          <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="mi">1</span> <span class="p">(</span><span class="nb">bitwise-and </span><span class="nv">b</span> <span class="mi">1</span><span class="p">))</span> <span class="p">(</span><span class="nf">addmod</span> <span class="nv">a</span> <span class="nv">r</span> <span class="nv">p</span><span class="p">)</span> <span class="nv">r</span><span class="p">)</span>
      <span class="p">)</span>
      <span class="nv">r</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre>
</div>


<p>Instead of a while loop, the scheme implementation of mulmod calls
itself. Scheme doesn't have looping constructs because of the way the
language was designed; there is no need for a special form to do this
because Scheme allows you to conveniently define iterative processes by
means of recursive procedures.</p>

<p>Porting this function was the moment where I decided to move over from
mit-scheme to plt-scheme, also known as Racket. In order to stay close
to the original I wanted to use the <a href="http://en.wikipedia.org/wiki/Bitwise_operation">bitwise
operations</a> AND (&amp;) and
the right arithmetic shift (>>=). Unfortunately to the best of my
knowledge mit-scheme doesn't offer built in bitwise operations on
anything but
<a href="http://web.mit.edu/scheme_v9.0.1/doc/mit-scheme-ref/Fixnum-Operations.html">fixnums</a>
and <a href="http://www.cse.iitb.ac.in/~as/mit-scheme/scheme_10.html#SEC103">bit
strings</a>,
but luckily <a href="http://docs.racket-lang.org/reference/generic-numbers.html#%28part._.Bitwise_.Operations%29">racket
does</a>.</p>

<p>Next up is powmod:</p>

<div class="highlight"><pre><code class="cpp"><span class="n">u64</span> <span class="nf">powmod</span><span class="p">(</span><span class="n">u64</span> <span class="n">a</span><span class="p">,</span> <span class="n">u64</span> <span class="n">e</span><span class="p">,</span> <span class="n">u64</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u64</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">e</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">r</span> <span class="o">=</span> <span class="n">mulmod</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
        <span class="n">e</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">mulmod</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>


<p>Which follows almost the exact same structure as mulmod:</p>

<div class="highlight"><pre><code class="racket"><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">powmod</span> <span class="nv">a</span> <span class="nv">e</span> <span class="nv">p</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">powmod_rec</span> <span class="nv">a</span> <span class="nv">e</span> <span class="nv">p</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
<span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">powmod_rec</span> <span class="nv">a</span> <span class="nv">e</span> <span class="nv">p</span> <span class="nv">r</span><span class="p">)</span>
    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt; </span><span class="nv">e</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">(</span><span class="nf">powmod_rec</span> <span class="p">(</span><span class="nf">mulmod</span> <span class="nv">a</span> <span class="nv">a</span> <span class="nv">p</span><span class="p">)</span>
            <span class="p">(</span><span class="nb">arithmetic-shift </span><span class="nv">e</span> <span class="mi">-1</span><span class="p">)</span>
            <span class="nv">p</span>
            <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="mi">1</span> <span class="p">(</span><span class="nb">bitwise-and </span><span class="nv">e</span> <span class="mi">1</span><span class="p">))</span> <span class="p">(</span><span class="nf">mulmod</span> <span class="nv">r</span> <span class="nv">a</span> <span class="nv">p</span><span class="p">)</span> <span class="nv">r</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="nv">r</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre>
</div>


<p>Note that instead of doing assigning 0 to r before the while loop in
mulmod we seed that 0 as a parameter every time mulmod is called to
mulmod_rec. The same goes for powmod and powmod_rec.</p>

<p>To tie it all together we have the fib function:</p>

<div class="highlight"><pre><code class="cpp"><span class="n">u64</span> <span class="nf">fib</span><span class="p">(</span><span class="n">u64</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u64</span> <span class="n">p</span>     <span class="o">=</span> <span class="mh">0xa94fad42221f27ad</span><span class="p">;</span>
    <span class="n">u64</span> <span class="n">v</span>     <span class="o">=</span> <span class="mh">0x0b92025517515f58</span><span class="p">;</span>
    <span class="n">u64</span> <span class="n">v_inv</span> <span class="o">=</span> <span class="mh">0x242d231e3eb01b01</span><span class="p">;</span>

    <span class="n">u64</span> <span class="n">a</span>        <span class="o">=</span> <span class="n">powmod</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">v</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
    <span class="n">u64</span> <span class="n">b</span>        <span class="o">=</span> <span class="n">powmod</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">v</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
    <span class="n">u64</span> <span class="n">pow2_inv</span> <span class="o">=</span> <span class="n">powmod</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

    <span class="n">u64</span> <span class="n">diff</span>   <span class="o">=</span> <span class="n">submod</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
    <span class="n">u64</span> <span class="n">factor</span> <span class="o">=</span> <span class="n">mulmod</span><span class="p">(</span><span class="n">v_inv</span><span class="p">,</span> <span class="n">pow2_inv</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">mulmod</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">factor</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>


<p>Which in Racket looks like:</p>

<div class="highlight"><pre><code class="racket"><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">fib</span> <span class="nv">n</span><span class="p">)</span>
    <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">q</span><span class="p">)</span>     <span class="mi">12200160415121876909</span><span class="p">)</span>
    <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">v</span><span class="p">)</span>     <span class="mi">833731445503647576</span><span class="p">)</span>
    <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">v_inv</span><span class="p">)</span> <span class="mi">2606778372125104897</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">mulmod</span> <span class="p">(</span><span class="nf">submod</span> <span class="p">(</span><span class="nf">powmod</span> <span class="p">(</span><span class="nb">+ </span><span class="mi">1</span> <span class="p">(</span><span class="nf">v</span><span class="p">))</span> <span class="nv">n</span> <span class="p">(</span><span class="nf">q</span><span class="p">))</span>
              <span class="p">(</span><span class="nf">powmod</span> <span class="p">(</span><span class="nb">- </span><span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nf">q</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="nf">v</span><span class="p">))</span> <span class="nv">n</span> <span class="p">(</span><span class="nf">q</span><span class="p">))</span>
              <span class="p">(</span><span class="nf">q</span><span class="p">)</span>
          <span class="p">)</span>
          <span class="p">(</span><span class="nf">mulmod</span> <span class="p">(</span><span class="nf">v_inv</span><span class="p">)</span>
              <span class="p">(</span><span class="nf">powmod</span> <span class="mi">2</span> <span class="p">(</span><span class="nb">- </span><span class="p">(</span><span class="nf">q</span><span class="p">)</span> <span class="mi">1</span> <span class="nv">n</span><span class="p">)</span> <span class="p">(</span><span class="nf">q</span><span class="p">))</span>
              <span class="p">(</span><span class="nf">q</span><span class="p">)</span>
          <span class="p">)</span>
          <span class="p">(</span><span class="nf">q</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre>
</div>


<p>So now we have all the components to generate a Fibonacci number. It
would of course be way more gratifying to have the program compute all
the numbers up to <a href="http://ruudvanasseldonk.com/2014/07/01/fibonacci-numbers-in-finite-fields#finite-fields">the maximum of
N=93</a>
instead of simply computing one at a time. To do that we can use the
<a href="http://docs.racket-lang.org/reference/when_unless.html">when evaluator</a>
in a recursive procedure. Full disclosure though: it would probably be
faster to use the regular iterative method if you are going to calculate
all the numbers anyway, but that doesn't take away the fun.</p>

<div class="highlight"><pre><code class="racket"><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">fib-iter</span> <span class="nv">n</span> <span class="nv">count</span> <span class="nv">result</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">display </span><span class="s">&quot;Computing fib for &quot;</span><span class="p">)(</span><span class="nb">display </span><span class="nv">count</span><span class="p">)(</span><span class="nb">display </span><span class="s">&quot;: &quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">display </span><span class="nv">result</span><span class="p">)(</span><span class="nf">newline</span><span class="p">)</span>
    <span class="p">(</span><span class="k">when </span><span class="p">(</span><span class="nb">&lt; </span><span class="nv">count</span> <span class="nv">n</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">fib-iter</span> <span class="nv">n</span>
            <span class="p">(</span><span class="nb">+ </span><span class="nv">count</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">(</span><span class="nf">fib</span> <span class="nv">count</span><span class="p">)</span>
      <span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">multifib</span> <span class="nv">n</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">fib-iter</span> <span class="nv">n</span> <span class="mi">1</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">)</span>
<span class="p">(</span><span class="nf">multifib</span> <span class="mi">93</span><span class="p">)</span>
</code></pre>
</div>


<p>And that's all there is to it: a racket fibonacci calculator that runs
in constant time by use of finite fields. Lots of praise to the original
author for this fascinating nugget of information and for figuring out
how to translate it into a working program.</p>

<p><a href="https://gist.github.com/vdloo/b3eed782c0b69617d718">You can find the put together version of this racket script on GitHub
Gist</a></p>

	
  </div>
    <p>
      <a href="/2014/07/03/fibonacci-in-finite-fields-in-racket/">Permalink</a>
    </p>
</div>
<hr>




<div class="row-fluid">
  <div class="span12">
    <div class="pagination">
      <ul>
        
        <li><span class="disabled">Prev</span></li>
        
        
        <li><span class="active">1</span></li>
        
        
          
          <li><a href="/page2">2</a></li>
          
        
          
          <li><a href="/page3">3</a></li>
          
        
        
        <li><a href="/page2">Next</a></li>
        
      </ul>
    </div>
  </div>
</div>


  </div>
  <div class="span4">
    <div id="about"><h3>About me</h3></div>

<p>
Rick van de Loo, software developer in the Amsterdam area. I like devops, cloud, python and LISP.
<br>
<br>
Find me on <a href="https://github.com/vdloo">Github</a> or <a href="mailto:rickvandeloo@gmail.com">drop me a line</a></p>
<hr>

<p>Other posts:</p>
<ul>
  
    <li><a href="/2014/11/24/configuring-network-bridge-debian-jessie-static-address/">Configuring a network bridge on Debian 8.0 for static addresses</a></li>
  
    <li><a href="/2014/11/21/partially-synchronising-a-structured-folder-to-smaller-storage/">Partially synchronising a structured folder (on a Synology machine) to a smaller storage</a></li>
  
    <li><a href="/2014/07/03/fibonacci-in-finite-fields-in-racket/">Implementing Fibonacci in finite fields, in racket</a></li>
  
    <li><a href="/2014/07/02/why-I-am-starting-the-SICP-reading-project-this-summer/">The SICP reading project</a></li>
  
    <li><a href="/2014/01/13/Suspend-and-continue-processes-in-a-shell-script/">Suspend and continue processes (ctrl+z) in a shell script</a></li>
  
    <li><a href="/2013/09/21/Fixing-the-ds-audio-and-video-you-are-not-authorized-to-use-this-service-error/">Not authorized to use this service in DS Audio and Video</a></li>
  
    <li><a href="/2012/08/01/Sending-data-over-Wi-Fi-without-associations/">Sending data over Wi-Fi without associations</a></li>
  
    <li><a href="/2012/08/01/Beacontalk-peer-to-peer-chat-program-that-sends-data-over-Wi-Fi-without-associations/">Beacontalk - Peer to peer chat-program that sends data over Wi-Fi without associations</a></li>
  
    <li><a href="/2012/06/03/Playlist2XBMC/">Playlist2XBMC</a></li>
  
</ul>

  </div>
</div>
</div>

  </body>
</html>

